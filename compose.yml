version: '3.8'

# Home IOT SCADA Stack - Podman Compose Configuration
# This file defines all services, networks, and volumes for the complete stack.
#
# USAGE:
#   1. Ensure secrets.env is configured with all required credentials
#   2. Export environment variables: export $(cat secrets.env | xargs)
#   3. Start the stack: podman-compose up -d
#   4. View logs: podman-compose logs -f
#   5. Stop the stack: podman-compose down
#
# IMPORTANT: Do NOT hardcode credentials in this file. Use environment variables
# from secrets.env and reference them with ${VARIABLE_NAME} syntax.

services:
  # ============================================================================
  # MESSAGING LAYER
  # ============================================================================
  
  # Mosquitto - MQTT Broker
  # Provides publish/subscribe messaging for IoT devices and services
  mosquitto:
    image: docker.io/eclipse-mosquitto:latest
    container_name: mosquitto
    restart: unless-stopped
    networks:
      - iot_stack_net
    ports:
      - "1883:1883"  # MQTT
      - "9001:9001"  # MQTT over WebSocket
    volumes:
      - mosquitto_data:/mosquitto/data
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    environment:
      - TZ=${TZ:-UTC}

  # ============================================================================
  # DATA STORAGE LAYER
  # ============================================================================
  
  # InfluxDB - Time-Series Database
  # Stores sensor data, metrics, and telemetry optimized for time-series workloads
  influxdb:
    image: docker.io/influxdb:2.7
    container_name: influxdb
    restart: unless-stopped
    networks:
      - iot_stack_net
    ports:
      - "8086:8086"  # InfluxDB HTTP API
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_ADMIN_USER}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_ADMIN_TOKEN}
      - TZ=${TZ:-UTC}
    volumes:
      - influxdb_data:/var/lib/influxdb2

  # ============================================================================
  # VISUALIZATION LAYER
  # ============================================================================
  
  # Grafana - Data Visualization and Dashboards
  # Provides advanced monitoring dashboards and data visualization
  grafana:
    image: docker.io/grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    networks:
      - iot_stack_net
    ports:
      - "3000:3000"  # Grafana Web UI
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_SECURITY_SECRET_KEY=${GRAFANA_SECRET_KEY}
      - GF_AUTH_ANONYMOUS_ENABLED=${GRAFANA_ANONYMOUS_ENABLED:-false}
      - GF_AUTH_ANONYMOUS_ORG_NAME=${GRAFANA_ANONYMOUS_ORG_NAME:-Main Org.}
      - GF_AUTH_ANONYMOUS_ORG_ROLE=${GRAFANA_ANONYMOUS_ORG_ROLE:-Viewer}
      - TZ=${TZ:-UTC}
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - influxdb

  # ============================================================================
  # HMI/SCADA LAYER
  # ============================================================================
  
  # FUXA - Web-based HMI/SCADA Editor and Runtime
  # Provides visual, floorplan-based interface for monitoring and controlling IoT devices
  fuxa:
    image: docker.io/frangoteam/fuxa:latest
    container_name: fuxa
    restart: unless-stopped
    networks:
      - iot_stack_net
    ports:
      - "1881:1881"  # FUXA Web UI
    environment:
      - TZ=${TZ:-UTC}
    volumes:
      - fuxa_data:/usr/src/app/FUXA/server/_appdata
    depends_on:
      - mosquitto
      - influxdb

  # ============================================================================
  # AUTOMATION LAYER
  # ============================================================================
  
  # Node-RED - Visual Flow-Based Programming for Automation
  # Provides drag-and-drop automation logic and event processing
  node-red:
    image: docker.io/nodered/node-red:latest
    container_name: node-red
    restart: unless-stopped
    networks:
      - iot_stack_net
    ports:
      - "1880:1880"      # Node-RED Web UI
      # NOTE: Node-RED syslog ports commented out due to conflict with Telegraf
      # Uncomment below if you want Node-RED to receive syslog (and disable Telegraf's 514 port)
      # - "1514:514/udp"   # Syslog listener (UDP) - mapped to host port 1514 to avoid conflict
      # - "1514:514/tcp"   # Syslog listener (TCP) - mapped to host port 1514 to avoid conflict
    environment:
      - TZ=${TZ:-UTC}
    volumes:
      - nodered_data:/data
    depends_on:
      - mosquitto
      - influxdb
    # Optional: Uncomment to enable Podman/Docker integration in Node-RED
    # Requires PODMAN_SOCKET_PATH to be set in secrets.env
    # volumes:
    #   - ${PODMAN_SOCKET_PATH}:/var/run/docker.sock:ro

  # ============================================================================
  # VIDEO SURVEILLANCE LAYER (NVR)
  # ============================================================================
  
  # Frigate - Network Video Recorder with AI Object Detection
  # Monitors camera feeds and detects objects (people, vehicles, animals)
  frigate:
    image: ghcr.io/blakeblackshear/frigate:stable
    container_name: frigate
    restart: unless-stopped
    networks:
      - iot_stack_net
    privileged: true  # Required for hardware acceleration (GPU, Coral TPU)
    ports:
      - "5000:5000"   # Frigate Web UI
      - "8554:8554"   # RTSP
      - "1935:1935"   # RTMP
    environment:
      - TZ=${TZ:-UTC}
    volumes:
      - frigate_data:/media/frigate
      - ./frigate_config.yml:/config/config.yml:ro
      - /etc/localtime:/etc/localtime:ro
    shm_size: '256mb'  # Shared memory for object detection (increase if needed)
    depends_on:
      - mosquitto

  # CompreFace - Face Recognition API
  # Provides facial recognition for identifying people in video frames
  compreface:
    image: docker.io/exadel/compreface:latest
    container_name: compreface
    restart: unless-stopped
    networks:
      - iot_stack_net
    ports:
      - "8000:8000"  # CompreFace API
    environment:
      - API_KEY=${COMPREFACE_API_KEY}
      - TZ=${TZ:-UTC}
    volumes:
      - compreface_data:/root/.cache

  # ============================================================================
  # METRICS COLLECTION LAYER
  # ============================================================================
  
  # Telegraf - Metrics Collection Agent
  # Collects system metrics and syslog data from network devices, forwards to InfluxDB
  telegraf:
    image: docker.io/telegraf:latest
    container_name: telegraf
    restart: unless-stopped
    networks:
      - iot_stack_net
    ports:
      - "514:514/udp"  # Syslog listener (UDP)
      # NOTE: Port 514 conflicts with Node-RED if both are configured for syslog
      # See Node-RED service comments for alternative configuration
    environment:
      - INFLUX_TOKEN=${INFLUXDB_ADMIN_TOKEN}
      - INFLUX_ORG=${INFLUXDB_ORG}
      - INFLUX_BUCKET=${INFLUXDB_BUCKET}
      - TZ=${TZ:-UTC}
    volumes:
      # Mount telegraf.conf with SELinux label :Z for proper permissions
      - ./docker/telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:Z
    depends_on:
      - influxdb

  # ============================================================================
  # ADDITIONAL SERVICES (from existing stack)
  # ============================================================================
  
  # Zigbee2MQTT - Zigbee to MQTT Bridge
  # Uncomment to enable Zigbee device integration
  # Requires USB Zigbee adapter (e.g., CC2652, ConBee II)
  # zigbee2mqtt:
  #   image: docker.io/koenkk/zigbee2mqtt:latest
  #   container_name: zigbee2mqtt
  #   restart: unless-stopped
  #   networks:
  #     - iot_stack_net
  #   ports:
  #     - "8080:8080"  # Zigbee2MQTT Web UI
  #   environment:
  #     - MQTT_SERVER=mqtt://mosquitto
  #     - MQTT_USER=${MQTT_USER}
  #     - MQTT_PASSWORD=${MQTT_PASSWORD}
  #     - TZ=${TZ:-UTC}
  #   volumes:
  #     - zigbee2mqtt_data:/app/data
  #   devices:
  #     - ${ZIGBEE_DEVICE_PATH}:/dev/zigbee
  #   cap_add:
  #     - NET_ADMIN
  #     - SYS_ADMIN
  #   depends_on:
  #     - mosquitto

  # Double-Take - Face Detection from Frigate Events
  # Uncomment to enable facial recognition in NVR workflow
  # doubletake:
  #   image: docker.io/jakowenko/double-take:latest
  #   container_name: doubletake
  #   restart: unless-stopped
  #   networks:
  #     - iot_stack_net
  #   ports:
  #     - "3001:3000"  # Double-Take Web UI
  #   environment:
  #     - TZ=${TZ:-UTC}
  #   volumes:
  #     - doubletake_data:/.storage
  #   depends_on:
  #     - frigate
  #     - compreface

  # go2rtc - RTSP to WebRTC/HLS Converter
  # Uncomment to enable low-latency camera streaming in browser/Grafana
  # go2rtc:
  #   image: ghcr.io/alexxit/go2rtc:latest
  #   container_name: go2rtc
  #   restart: unless-stopped
  #   networks:
  #     - iot_stack_net
  #   ports:
  #     - "1984:1984"       # go2rtc Web UI
  #     - "8554:8554"       # RTSP server
  #     - "8555:8555/tcp"   # WebRTC
  #     - "8555:8555/udp"   # WebRTC
  #   environment:
  #     - TZ=${TZ:-UTC}
  #   volumes:
  #     - go2rtc_data:/config

  # Nginx - Reverse Proxy
  # Uncomment to enable hostname-based routing for all web services
  # nginx:
  #   image: docker.io/library/nginx:alpine
  #   container_name: nginx
  #   restart: unless-stopped
  #   networks:
  #     - iot_stack_net
  #   extra_hosts:
  #     - "host.containers.internal:host-gateway"
  #   ports:
  #     - "80:80"  # HTTP
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./nginx:/usr/share/nginx/html:ro
  #     - nginx_cache:/var/cache/nginx
  #   depends_on:
  #     - grafana
  #     - fuxa
  #     - nodered
  #     - frigate

# ============================================================================
# NETWORKS
# ============================================================================

networks:
  # Custom bridge network for service-to-service communication
  # Services can reference each other by container name as hostname
  # Example: http://influxdb:8086, mqtt://mosquitto:1883
  iot_stack_net:
    driver: bridge

# ============================================================================
# VOLUMES
# ============================================================================

volumes:
  # Persistent storage for service data
  # These volumes preserve data across container restarts and updates
  mosquitto_data:
  influxdb_data:
  grafana_data:
  fuxa_data:
  nodered_data:
  frigate_data:
  compreface_data:
  # Uncomment additional volumes as needed for optional services
  # zigbee2mqtt_data:
  # doubletake_data:
  # go2rtc_data:
  # nginx_cache:
